{% extends "layouts/base.html" %} {% load i18n %} {% block title %} {% trans 'Vocuher'%}
{% endblock title %}

{% block stylesheets %}{% endblock stylesheets %} {% block content %}
<main class="main-content bgc-grey-100">
    <div id="mainContent">
        <div class="container">
            <div style="align-items: center">
                <h3 class="c-grey-900 mB-20" style="text-align: center">{% trans 'Voucher'%}</h3>
            </div>
            <form method="post" action="">
                {% csrf_token %}
                <div class="row gx-4">

                    <div class="col-md-6">
                        <div class="mb-3 ">
                            <label class="form-label" class="text-normal text-dark">{% trans 'Chinese name'%}:</label>
                            {{form.chinese_name}}
                        </div>
                        <span class="text-danger">{{ form.errors.chinese_name }}</span>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3 ">
                            <label class="form-label" class="text-normal text-dark">{% trans 'English name'%}:</label>
                            {{form.english_name}}
                        </div>
                        <span class="text-danger">{{ form.errors.english_name.errors }}</span>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3 ">
                            <label class="form-label" class="text-normal text-dark">{% trans 'Voucher details'%}:</label>
                            {{form.voucher_details}}
                        </div>
                        <span class="text-danger">{{ form.errors.voucher_details }}</span>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3 ">
                            <label class="form-label" class="text-normal text-dark">{% trans 'Voucher highlights'%}:</label>
                            {{form.voucher_highlights}}
                        </div>
                        <span class="text-danger">{{ form.errors.voucher_highlights }}</span>
                    </div>
                    <!-- <div class="col-md-6">
                        <div class="mb-3 ">
                            <label class="form-label" class="text-normal text-dark">{% trans 'Discount type'%}:</label>
                            {{form.discount_type}}
                        </div>
                        <span class="text-danger">{{ form.discount_type.errors }}</span>
                    </div>

                    <div class="col-md-6" id="discount_value_div" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label text-normal text-dark">{% trans 'Discount value'%}:</label>
                            {{ form.discount_value }}
                        </div>
                        <span class="text-danger">{{ form.discount_value.errors }}</span>
                    </div> -->

                    <!-- <div class="col-md-6">
                        <div class="mb-3 ">
                            <label class="form-label" class="text-normal text-dark">{% trans 'Amount trigger'%}:</label>
                            {{form.amount_trigger}}
                        </div>
                        <span class="text-danger">{{ form.amount_trigger.errors }}</span>
                    </div> -->

                    <!-- <div class="col-md-6">
                        <div class="mb-3 ">
                            <label class="form-label" class="text-normal text-dark">{% trans 'Discount trigger'%}:</label>
                            {{form.quantity_trigger}}
                        </div>
                        <span class="text-danger">{{ form.quantity_trigger.errors }}</span>
                    </div> -->

                    <div class="col-md-6">
                        <div class="mb-3 ">
                            <label class="form-label" class="text-normal text-dark">{% trans 'Quota'%}:</label>
                            {{form.quota}}
                        </div>
                        <span class="text-danger">{{ form.errors.quota.errors }}</span>
                    </div>

                    <!-- <div class="col-md-6">
                        <div class="mb-3 ">
                            <label class="form-label" class="text-normal text-dark">{% trans 'One time use only'%}:</label>
                            {{form.one_time_use_only}}
                        </div>
                        <span class="text-danger">{{ form.one_time_use_only.errors }}</span>
                    </div> -->

                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label" class="text-normal text-dark">{% trans 'Start date'%}:</label>
                            <div class="input-group">
                                <div class="input-group-text bgc-white bd bdwR-0">
                                    <i class="ti-calendar"></i>
                                </div>
                                <input type="text" class="form-control bdc-grey-200 start-date" value="{{form.start_date.value|date:'d/m/Y'}}" id="id_start_date" name="start_date" data-provide="datepicker">
                            </div>
                        </div>
                        <span class="text-danger">{{ form.errors.start_date }}</span>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label" class="text-normal text-dark">{% trans 'End date(optional)'%}:</label>
                            <div class="input-group">
                                <div class="input-group-text bgc-white bd bdwR-0">
                                    <i class="ti-calendar"></i>
                                </div>
                                <input type="text" class="form-control bdc-grey-200 start-date" value="{{form.end_date.value|date:'d/m/Y'}}" id="id_end_date" name="end_date" data-provide="datepicker">
                            </div>
                        </div>
                        <span class="text-danger">{{ form.errors.end_date }}</span>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3 ">
                            <label class="form-label" class="text-normal text-dark">{% trans 'Status'%}:</label>
                            {{form.status}}
                        </div>
                        <span class="text-danger">{{ form.errors.status}}</span>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3 ">
                            <label class="form-label" class="text-normal text-dark">{% trans 'Voucher type'%}:</label>
                            {{form.voucher_type}}
                        </div>
                        <span class="text-danger">{{ form.errors.voucher_type }}</span>
                    </div>
                        <div id="hidden_form" style="display: none;">
                    </div>

                    <input type="hidden" name="productDetails" id="orderDetailsInput" value="" />
                    <div style="display: flex; justify-content: center; ">
                        <button class="btn btn-primary rounded btn-send" type="submit" style="color: white">{% trans 'Submit' %}</button>
                    </div>
                </div>
            </form>
            {{ msg }}
        </div>
    </div>
</main>
{% endblock content %}
<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script>
    var voucherTypeSelect = document.getElementById('id_voucher_type');
    voucherTypeSelect.addEventListener('change', updateHiddenForm);
    var ids = 0;
    var productList = [];
    var hiddenForm = document.getElementById('hidden_form');
    var product_ids = [];
    function updateHiddenForm() {

        var formContent = "";

        if (voucherTypeSelect.value === "Product Combo") {
            ids = 0;
            formContent =
                `
                <div class="mb-3">
                    <label>{% trans 'Product List' %}:</label>
                </div>
                <table id="dataTable2" class="table table-striped table-bordered" cellspacing="0" width="100%">
                    <thead style="text-align: center;">
                        <th>{% trans 'Product No' %}</th>
                        <th>{% trans 'Chinese name' %}</th>
                        <th>{% trans 'English name' %}</th>
                        <th>{% trans 'Supplier Product Name' %}</th>
                        <th></th>
                    </thead>
                    <tbody class="" style="text-align: center;">
                        {% for product in products %}
                        <tr>
                            <td>{{ product.product_id }}</td>
                            <td>{{ product.product_chinese_name }}</td>
                            <td>{{ product.product_english_name }}</td>
                            <td>{{ product.supplier_product_name }}</td>
                            <td>
                                <button type="button" 
                                onclick="addToProductList('{{product.id}}', '{{ product.product_id }}', '{{product.product_chinese_name}}', '{{product.product_english_name}}')" 
                                class="btn btn-primary btn-sm">
                                <i class="ti-plus" style="color: white;">
                                </i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <div class="mb-3">
                    <label>{% trans 'Combo' %}:</label>
                </div>
                <table id="dataTable2" class="table table-striped table-bordered" cellspacing="0" width="100%">
                    <thead style="text-align: center;">
                        <th>{% trans 'Product No' %}</th>
                        <th>{% trans 'Chinese name' %}</th>
                        <th>{% trans 'Minimum Quantity' %}</th>
                        <th>{% trans 'Maximum Quantity' %}</th>
                        <th>{% trans 'Discount Type' %}</th>
                        <th>{% trans 'Discount Value' %}</th>
                        <th>{% trans 'Action' %}</th>
                    </thead>
                    <tbody class="" id="combos" style="text-align: center;">
                    </tbody>
                </table>
                
                <!-- <div class="row gx-4">
                    <div class="col-md-6">
                        <div class="mb-3 mt-3">
                            <label class="form-label text-normal text-dark">{% trans 'Discount type'%}:</label>
                            {{form.discount_type}}
                        </div>
                        <span class="text-danger">{{ form.discount_type.errors }}</span>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-normal text-dark">{% trans 'Discount value'%}:</label>
                            {{ form.discount_value }}
                        </div>
                        <span class="text-danger">{{ form.discount_value.errors }}</span>
                    </div>
                </div> -->
                `;
            hiddenForm.style.display = 'block';
        }
        else if (voucherTypeSelect.value === "Discount Voucher" || voucherTypeSelect.value === "Free Gift") {
            ids = 0;
            var labelContent = voucherTypeSelect.value === "Free Gift" ? '{% trans "Gift List" %}' : '{% trans "Eligible Products" %}';
            var quantityContent = voucherTypeSelect.value === "Free Gift" ? '{% trans "Total Quantity" %}' : '{% trans "Quantity" %}';
            var PriceContent = voucherTypeSelect.value === "Free Gift" ? '{% trans "Total Price" %}' : '{% trans "Price" %}';

            formContent =
                `
                <div class="row gx-4">
                    <div class="col-md-6">
                        <div class="mb-3 mt-3">
                            <label class="form-label text-normal text-dark">${quantityContent}:</label>
                            <input type="number" class="form-control" id="id_quantity"/>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3 mt-3">
                            <label class="form-label text-normal text-dark">{% trans 'Quantity Condition'%}:</label>
                            <select class="form-control" id="id_quantity_codition">
                                <option value="">------</option>
                                <option value="More than">{% trans 'More than' %}</option>
                                <option value="More than and equals to">{% trans 'More than and equals to' %}</option>
                                <option value="Equals to">{% trans 'Equals to' %}</option>
                                <option value="Less than and equals to">{% trans 'Less than and equals to' %}</option>
                                <option value="Less than">{% trans 'Less than' %}</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3 mt-3">
                            <label class="form-label text-normal text-dark">${PriceContent}:</label>
                            <input type="number" class="form-control" id="id_price"/>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3 mt-3">
                            <label class="form-label text-normal text-dark">{% trans 'Price Condition'%}:</label>
                            <select class="form-control" id="id_amount_codition">
                                <option value="">------</option>
                                <option value="More than">{% trans 'More than' %}</option>
                                <option value="More than and equals to">{% trans 'More than and equals to' %}</option>
                                <option value="Equals to">{% trans 'Equals to' %}</option>
                                <option value="Less than and equals to">{% trans 'Less than and equals to' %}</option>
                                <option value="Less than">{% trans 'Less than' %}</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3 mt-3">
                            <label class="form-label text-normal text-dark">{% trans 'Category'%}:</label>
                            <select class="form-control" id="id_category">
                            <option value=''>------</option>
                            {% for category in categories %}
                                <option value={{category.id}}>{{ category.name }}</option>
                            {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6"${voucherTypeSelect.value === "Free Gift" ? 'style="display: none;"' : ''}>
                        <div class="mb-3 mt-3">
                            <label class="form-label text-normal text-dark">{% trans 'Discount type'%}:</label>
                            <select class="form-control" id="id_discount_type">
                                <option value='Fixed Amount'>Fixed Amount</option>
                                <option value='Rate(%)'>Rate(%)</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6"${voucherTypeSelect.value === "Free Gift" ? 'style="display: none;"' : ''}>
                        <div class="mb-3">
                            <label class="form-label text-normal text-dark">{% trans 'Discount value'%}:</label>
                            <input type="number" class="form-control" id="id_discount_price"/>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3 mt-3">
                            <label class="form-label text-normal text-dark">{% trans 'No of Gifts'%}:</label>
                            <input type="number" class="form-control" id="id_no_of_gift"/>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-normal text-dark">{% trans 'Product List' %}:</label>
                    </div>

                    <table id="dataTable2" class="table table-striped table-bordered" cellspacing="0" width="100%">
                        <thead style="text-align: center;">
                            <th>{% trans 'Product No' %}</th>
                            <th>{% trans 'Chinese name' %}</th>
                            <th>{% trans 'English name' %}</th>
                            <th>{% trans 'Supplier Product Name' %}</th>
                            <th></th>
                        </thead>
                        <tbody class="" style="text-align: center;">
                            {% for product in products %}
                            <tr>
                                <td>{{ product.product_id }}</td>
                                <td>{{ product.product_chinese_name }}</td>
                                <td>{{ product.product_english_name }}</td>
                                <td>{{ product.supplier_product_name }}</td>
                                <td>
                                    <button type="button" 
                                    onclick="addToEligibleList('{{product.id}}', '{{ product.product_id }}', '{{product.product_chinese_name}}', '{{product.product_english_name}}')" 
                                    class="btn btn-primary btn-sm">
                                    <i class="ti-plus" style="color: white;">
                                    </i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
    
                    <div class="mb-3">
                        <label class="form-label text-normal text-dark">
                            ${labelContent}
                        </label>
                    </div>
                    <table id="dataTable2" class="table table-striped table-bordered" cellspacing="0" width="100%">
                        <thead style="text-align: center;">
                            <th>{% trans 'Product No' %}</th>
                            <th>{% trans 'Chinese name' %}</th>
                            <th>{% trans 'English name' %}</th>
                            <th>{% trans 'Action' %}</th>
                        </thead>
                        <tbody class="" id="eligible_products" style="text-align: center;">
                        </tbody>
                    </table>
                </div>
            `;
            hiddenForm.style.display = 'block';
        }

        hiddenForm.innerHTML = formContent;
        $('#dataTable2').DataTable({
            "scrollX": true
            // Add other DataTables options as needed
        });
    }

    function addToProductList(productId, productNo, productName, productEnglishName) {
        ids++;
        var combos = document.getElementById('combos');
        combos.insertAdjacentHTML('beforeend',
            `
                                        <tr id="${productId}_${ids}_row">
                                            <td>
                                                ${productNo}
                                            </td>
                                            <td>
                                                ${productName}
                                            </td>
                                            <td style="width: 12%;"  id="${productId}_${ids}_min_qty_div">
                                                <input type="number" class="form-control" name="min_qty" id="${productId}_${ids}_min_qty"/>
                                            </td>
                                            <td style="width: 12%;"  id="${productId}_${ids}_max_qty_div">
                                                <input type="number" class="form-control" name="max_qty" id="${productId}_${ids}_max_qty"/>
                                            </td>
                                            <td style="width: 12%;"  id="${productId}_${ids}_discount_type_div">
                                                <select class="form-control" id="${productId}_${ids}_discount_type">
                                                    <option value='Fixed Amount'>Fixed Amount</option>
                                                    <option value='Rate(%)'>Rate(%)</option>
                                                </select>
                                            </td>
                                            <td style="width: 12%;"  id="${productId}_${ids}_discount_value_div">
                                                <input type="number" class="form-control" name="discont_value" id="${productId}_${ids}_discount_value"/>
                                            </td>
                                            <td style="width: 12%;">
                                                <div style="disply: flex; justify-content: space-evenly">   
                                                    <button type="button" class="btn btn-success btn-sm" id="${productId}_${ids}_confirmproduct" onclick="confirmProduct('${productId}', '${ids}')">
                                                        <i class="ti-check" style="color: white;"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeRow('${productId}_${ids}_row', '${productId}', '${ids}')">
                                                        <i class="ti-trash" style="color: white;"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        `)

    }

    function removeRow(rowId, productId, ids) {
        productList = productList.filter((product) => product.id !== ids);
        product_ids = product_ids.filter((product) => product !== productId);
        var row = document.getElementById(rowId);
        row.parentNode.removeChild(row);
    }

    function confirmProduct(productId, ids) {

        var min_value = parseFloat(document.getElementById(productId + "_" + ids + "_min_qty").value);
        var max_value = parseFloat(document.getElementById(productId + "_" + ids + "_max_qty").value);
        var dis_type = document.getElementById(productId + "_" + ids + "_discount_type").value;
        var dis_value = parseFloat(document.getElementById(productId + "_" + ids + "_discount_value").value);

        // Convert values to numbers
        min_value = parseFloat(min_value);
        max_value = parseFloat(max_value);
        dis_value = parseFloat(dis_value);

        // Check for valid numbers
        if (isNaN(min_value) || min_value === 0 || min_value < 0) {
            alert("You can't put 0, negative value, or None in Minimum Quantity!");
            return;
        }

        if (isNaN(max_value) || max_value === 0 || max_value < 0) {
            alert("You can't put 0, negative value, or None in Maximum Quantity!");
            return;
        }

        if (max_value < min_value) {
            alert("Max Quantity should be greater than Minimum Quantity!");
            return;
        }

        if (min_value === max_value) {
            alert("You can't put the same amount in Minimum Quantity and Maximum Quantity!");
            return;
        }

        if (dis_type == undefined) {
            alert("Please select discount type!");
            return;
        }

        if (isNaN(dis_value) || dis_value == 0 || dis_value < 0) {
            alert("You can't put 0, negative value, or None in discount value!");
            return;
        }

        if (dis_type === "Rate(%)" && dis_value > 100) {
            alert("Rate(%) discount value can't be more than 100");
            return;
        }

        var min_div = document.getElementById(productId + "_" + ids + "_min_qty_div");
        min_div.innerHTML = '';
        min_div.insertAdjacentHTML('beforeend', `<label>${min_value}</label>`);

        var max_div = document.getElementById(productId + "_" + ids + "_max_qty_div");
        max_div.innerHTML = '';
        max_div.insertAdjacentHTML('beforeend', `<label>${max_value}</label>`);

        var type_div = document.getElementById(productId + "_" + ids + "_discount_type_div");
        type_div.innerHTML = '';
        type_div.insertAdjacentHTML('beforeend', `<label>${dis_type}</label>`);

        var dis_value_div = document.getElementById(productId + "_" + ids + "_discount_value_div");
        dis_value_div.innerHTML = '';
        dis_value_div.insertAdjacentHTML('beforeend', `<label>${dis_value}</label>`);

        var details = {
            id: ids,
            product_id: productId,
            min_quantity: min_value,
            max_quantity: max_value,
            discount_type: dis_type,
            discount_value: dis_value,
        }

        productList.push(details);
        document.getElementById(productId + "_" + ids + "_confirmproduct").disabled = true;
    }

    function addToEligibleList(productId, productNo, productName, productEnglishName) {

        if (product_ids.includes(productId)) {
            alert("This product is already in the eligibility list.");
            return;
        }

        var products = document.getElementById('eligible_products');
        products.insertAdjacentHTML('beforeend',
            `
                                        <tr id="${productId}_${ids}_row">
                                            <td>
                                                ${productNo}
                                            </td>
                                            <td>
                                                ${productName}
                                            </td>
                                            <td>
                                                ${productEnglishName}
                                            </td>
                                            <td>   
                                                <button type="button" class="btn btn-danger btn-sm" onclick="removeRow('${productId}_${ids}_row', '${productId}', '${ids}')">
                                                    <i class="ti-trash" style="color: white;"></i>
                                                </button>
                                            </td>
                                        `);
        product_ids.push(productId);

    }

    document.querySelector('form').addEventListener('submit', function (event) {
        // Prevent the form from submitting by default
        event.preventDefault();
        if (voucherTypeSelect.value == "Discount Voucher" || voucherTypeSelect.value == "Free Gift") {
            quantity = document.getElementById("id_quantity").value;
            price = document.getElementById("id_price").value;
            amount_trigger = document.getElementById("id_amount_codition").value;
            quantity_trigger = document.getElementById("id_quantity_codition").value;
            category_id = document.getElementById("id_category").value;
            discount_type = document.getElementById("id_discount_type").value;
            discount_price = document.getElementById("id_discount_price").value;
            no_of_gift = document.getElementById("id_no_of_gift").value;

            if (product_ids.length === 0) {
                alert('Please add at least one product to the eligible list.');
                return;
            }

            if (quantity < 0 || isNaN(quantity)) {
                alert("Invalid quantity value!");
                return;
            }

            if (price < 0 || isNaN(price)) {
                alert("Invalid price value!");
                return;
            }

            if (voucherTypeSelect.value == "Discount Voucher") {
                
                if (isNaN(discount_price) || discount_price === 0 || discount_price < 0 || !discount_price) {
                    alert("Invalid discount Price!");
                    return;
                }
                
            }

            if (!quantity && !price && !category_id) {
                alert("You can't put None or 0 in price, quantity, and category!");
                return;
            }

            if ((!isNaN(quantity) && quantity === 0) && quantity_trigger !== undefined) {
                alert("You can't select quantity condition when quantity is 0 or None!");
                return;
            }

            if ((!isNaN(price) && price === 0) && amount_trigger !== undefined) {
                alert("You can't select price condition when price is 0 or None!");
                return;
            }

            if (!quantity) {
                quantity = undefined;
            }

            if (!price) {
                price = undefined;
            }
            
            if(!no_of_gift) {
                no_of_gift = 0;
            } 

            ids++;
            productList.push({
                id: ids,
                only_available_to: product_ids,
                quantity: quantity,
                price: price,
                amount_trigger: amount_trigger,
                quantity_trigger: quantity_trigger,
                category_id: category_id,
                discount_type: discount_type,
                discount_value: discount_price,
                no_of_gift: no_of_gift
            })
        }
        else if (voucherTypeSelect.value == "Product Combo") {

            if (productList.length === 0) {
                alert('Please add at least one product to the product list.');
                return;
            }

        }

        document.getElementById('orderDetailsInput').value = JSON.stringify(productList);

        this.submit();
    });

    $(document).ready(function () {
        // Initialize DataTables for the product list table
        $('#dataTable2').DataTable({
            "scrollX": true
            // Add other DataTables options as needed
        });
    });

</script>
{% endblock javascripts %}

<!-- <td style="width: 12%;"  id="${productId}_${ids}_category_div">
    <select class="form-control" id="${productId}_${ids}_category">
        {% for category in categories %}
            <option value="{{ category.id }}">{{category.name}}</option>
        {% endfor %}
    </select>
</td> -->